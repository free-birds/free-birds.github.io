<!DOCTYPE html>
<html lang="en">
    <head>
    <meta charset="UTF-8" />
    <title> Staying Sane With Asynchronous Programming：Promises and Generators - Shmily </title>
    <meta name="generator" content="Jekyll" />
    <meta name="keywords" content="" />
    <meta name="description" content="" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1,user-scalable=no" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-touch-fullscreen" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="format-detection" content="email=no" />
    <meta name="format-detection" content="address=no" />

    <link rel="icon" type="image/png" sizes="96x96" href="/static/imgs/favicon/favicon-32x32.png" />
    <link rel="stylesheet" href="/static/css/layout.css" />
</head>
<body>
    <!--[if lt IE 8]>
<div>
    <p>
        已经有超过90%的用户使用更高版本
        <a target="_blank" title="下载Chrome" href="http://www.google.com/chrome/">Google Chrome</a>
        或
        <a target="_blank" href="http://www.microsoft.com/zh-cn/download/ie.aspx?q=internet+explorer">Internet Explorer</a>
        体验到了更流畅更精彩的页面，你还不试试？
    </p>
</div>
<![endif]-->

<header class="header">
    <nav class="navbar">
        <div class="slogan">
            <a href="/">Shmily</a>
        </div>
        <div class="menu">
            <spam class="menu-icon" id="js-menu-toggle"></spam>
            <ul class="menu-list">
                
                <li class="menu-item">
                <a href="/home/">
                <i class="fa "></i>
                Home</a>
                </li>
                
                <li class="menu-item">
                <a href="/posts/">
                <i class="fa "></i>
                Posts</a>
                </li>
                
                <li class="menu-item">
                <a href="/about/">
                <i class="fa "></i>
                About Me</a>
                </li>
                
            </ul>
        </div>
    </nav>
</header>

    <section class="content">
        <article>
            <div class="markdown-body">
  <h1>Staying Sane With Asynchronous Programming：Promises and Generators</h1>
  <p class="meta">29 Oct 2015 - Meituan, Beijing</p>
  <p>Callback Hell, also known as Pyramid of Doom, is an anti-pattern seen in code of programmers who are not wise in the ways of asynchronous programming.</p>

<!--more-->

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">async1</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
    <span class="nx">async2</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
        <span class="nx">async3</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
            <span class="nx">async4</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
                <span class="p">....</span>
            <span class="p">});</span>
        <span class="p">});</span>
    <span class="p">});</span>
<span class="p">});</span></code></pre></figure>

<p>It consists of multiple nested callbacks which makes code hard to read and debug. It is understandable how one might unknowingly get caught in Callback Hell while dealing with asynchronous logic.</p>

<p><img src="/static/img/post/generator-1.gif" alt="img" /></p>

<h2 id="promise">Promise</h2>

<p>A little preview of how a promise-based approach solves the callback hell:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// Callback approach</span>
<span class="nx">async1</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
    <span class="nx">async2</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
        <span class="nx">async3</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
            <span class="p">....</span>
        <span class="p">});</span>
    <span class="p">});</span>
<span class="p">});</span>

<span class="c1">// Promise approach</span>
<span class="kd">var</span> <span class="nx">task1</span> <span class="o">=</span> <span class="nx">async1</span><span class="p">();</span>
<span class="kd">var</span> <span class="nx">task2</span> <span class="o">=</span> <span class="nx">task1</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">async2</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">task3</span> <span class="o">=</span> <span class="nx">task2</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">async3</span><span class="p">);</span>

<span class="nx">task3</span><span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
    <span class="c1">// Solve your thrown errors from task1, task2, task3 here</span>
<span class="p">})</span>

<span class="c1">// Promise approach with chaining</span>
<span class="nx">async1</span><span class="p">(</span><span class="kd">function</span><span class="p">(){..})</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">async2</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">async3</span><span class="p">)</span>
    <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
        <span class="c1">// Solve your thrown errors here</span>
    <span class="p">})</span></code></pre></figure>

<p>Let’s break it down on what Promise is doing for us here:</p>

<ol>
  <li>Flattened callbacks</li>
  <li>Return values from asynchronous function</li>
  <li>Throw and Catch exceptions</li>
</ol>

<p>With flattened code hierarchy, the code are now much more readable. But that’s just the by-product of Promise. The main thing about Promise is that it helps us achieve (2) and (3). Achieving (2) and (3) is important because that is what synchronous function can do for us.</p>

<table>
  <tbody>
    <tr>
      <td>For Promise to make (2) and (3) work, the asynchronous function itself should <strong>return a Promise Object</strong>. This Promise object has two methods, <code class="highlighter-rouge">done</code> and <code class="highlighter-rouge">fail</code>. The methods will later be called depending on the state (fulflled</td>
      <td> </td>
      <td>rejected) of the Promise Object.</td>
    </tr>
  </tbody>
</table>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">asyncWithPromise</span><span class="p">()</span> <span class="c1">// Returns a promise object</span>
    <span class="p">.</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span> <span class="c1">// if object's state is fulfilled, go here</span>
        <span class="p">...</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span> <span class="c1">// if object's state is rejected, go here</span>
        <span class="p">...</span>
    <span class="p">})</span></code></pre></figure>

<h2 id="generators">Generators</h2>

<p>Generators, like Promise, is also one of the features in ES6 that can manage asynchronous programming. The great thing about Generators is that it can work hand-in-hand with Promise to bring us closer to synchronous programming.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="o">*</span> <span class="nx">g</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(.</span><span class="mi">5</span><span class="p">);</span>
    <span class="k">yield</span> <span class="mi">1</span><span class="p">;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="mf">1.5</span><span class="p">);</span>
    <span class="k">yield</span> <span class="mi">2</span><span class="p">;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="mf">2.5</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">gn</span> <span class="o">=</span> <span class="nx">g</span><span class="p">();</span>
<span class="nx">gn</span><span class="p">.</span><span class="nx">next</span><span class="p">();</span> <span class="c1">// 0.5 Object{ value: 1, done: false }</span>
<span class="nx">gn</span><span class="p">.</span><span class="nx">next</span><span class="p">();</span> <span class="c1">// 1.5 Object{ value: 2, done: false }</span>
<span class="nx">gn</span><span class="p">.</span><span class="nx">next</span><span class="p">();</span> <span class="c1">// 2.5 Object{ value: undefined, done: true }</span></code></pre></figure>

<p>Javascript function are expected to run-to-completion - This means once the function starts running, it will run to the end of the function. However, Generators allow us to interrupt this execution and switch to other tasks before returning back to the last interrupted task.</p>

<p>The weird-looking <code class="highlighter-rouge">function *()</code> is to inform the Javascript interpreter that this is a special generator function type while <code class="highlighter-rouge">yield</code> is the cue to interrupt the function.</p>

<h3 id="with-promise">With Promise</h3>

<p>It also could be <code class="highlighter-rouge">yield promise</code>.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// define promise</span>
<span class="kd">var</span> <span class="nx">Promise</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="s1">'http://hello13.net'</span><span class="p">,{</span>
        <span class="na">data</span><span class="p">:</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span><span class="na">data</span><span class="p">:</span><span class="s1">'serverData'</span><span class="p">}),</span>
        <span class="na">type</span><span class="p">:</span><span class="s1">'json'</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="c1">// define generator</span>
<span class="kd">function</span> <span class="o">*</span> <span class="nx">Generator</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'generator start'</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">Promise</span><span class="p">();</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">g</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Generator</span><span class="p">(),</span>
    <span class="nx">promise</span> <span class="o">=</span> <span class="nx">g</span><span class="p">.</span><span class="nx">next</span><span class="p">().</span><span class="nx">value</span><span class="p">;</span>

<span class="nx">promise</span><span class="p">.</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">g</span><span class="p">.</span><span class="nx">next</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
<span class="p">})</span></code></pre></figure>

<p>When the code enter the function, it will hit <code class="highlighter-rouge">console.log('generator start')</code> first. It then continues to the next line which hit the <code class="highlighter-rouge">yield</code> expression. This pauses the function and allow other code to run. But once promise is done and call <code class="highlighter-rouge">g.next(data)</code>, the paused function resumes and it continue to the last line of the function <code class="highlighter-rouge">console.log(data)</code>, and the data is <code class="highlighter-rouge">serverData</code>.</p>

</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="posts">
    
    <li class="text-ellipsis">
      <span>09 Dec 2015</span> &raquo; <a href="/posts/router//">Router Middleware For Koa</a>
    </li>
    
    <li class="text-ellipsis">
      <span>25 Nov 2015</span> &raquo; <a href="/posts/localstorage//">Front-End Engineering：Cache Management</a>
    </li>
    
    <li class="text-ellipsis">
      <span>23 Nov 2015</span> &raquo; <a href="/posts/yahoo//">Best Practices For Speeding Up Your Web Site</a>
    </li>
    
  </ul>
</div>
        </article>
    </section>
    <footer class="footer">
    <div class="copyright">
        <div class="contact">
            <p>Copyright @YML</p>
            <p>Geek of <a href="http://github.com/">GitHub</a></p>
            <p>aworksmart@gmail.com</p>
        </div>
        <div class="contact">
            <p><a href="http://weibo.com/ihaosir/">weibo.com/ihaosir</a></p>
            <p><a href="http://github.com/free-birds/">github.com/free-birds</a></p>
            <p><a href="http://childlike.me/">childlike.me</a></p>
        </div>
    </div>
</footer>

</body>
<script src="/static/js/libs/zepto.js"></script>
    <script src="/static/js/plugin.js"></script>
    <script src="/static/js/site.js"></script>
</html>
